<!DOCTYPE html>
<html>
<head>
	<title>Mapviewer for issue reporting API</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
 <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
 <![endif]-->
<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="js/syntaxhighlighter/syntaxhighlighter_3.0.83/scripts/shCore.js"></script>
<script type="text/javascript" src="js/syntaxhighlighter/syntaxhighlighter_3.0.83/scripts/shBrushJScript.js"></script>
<script type="text/javascript" src="js/spin.min.js"></script>
<script type="text/javascript" src="js/moment.min.js"></script>
<link href="js/syntaxhighlighter/syntaxhighlighter_3.0.83/styles/shCore.css" rel="stylesheet" type="text/css" />
<link href="js/syntaxhighlighter/syntaxhighlighter_3.0.83/styles/shThemeDefault.css" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="css/default.min.css">
<script type="text/javascript" src="js/highlight.min.js"></script>
</head>
<body>
<table>
<tr>
<td valign="top">
REQUEST: <input size="95" type="text" id="request_url" name="serviceid"/>
<button onclick="fetchReports()">Try it!</button>
<div id="url"></div>
<div id="map" style="width: 800px; height: 600px"></div>
<div id="response" style="width: 800px;">
<pre class="brush: js">
$.ajax({
  url:'https://asiointi.hel.fi/palautews/rest/v1/requests.json?extensions=true',
  dataType: 'json',
  success:function(json){
    $.each(json, function(entryIndex, entry) {
       var marker = L.marker([entry['lat'],entry['long']]);
       marker._serviceId = entry['service_request_id'];
       marker.bindPopup(t);
       group.addLayer(marker);
    });
    group.addTo(map);
    $("#json_response").html(JSON.stringify(json,null,2));
  },
  error:function(){
    alert("Error");
  },
});

map.on('popupopen', function(e) {
  var id;
  if (e.popup._source._serviceId != undefined) id = e.popup._source._serviceId;
  if (id != undefined){
    var latlng = e.popup._source.getLatLng();
    var url = 'https://asiointi.hel.fi/palautews/rest/v1/requests/' + id + '.json';
    $("#url").html('<a href=' + url + '>' + url + '</a>');
    $.ajax({
      url:url,
      dataType: 'json',
      success:function(json){
	$.each(json, function(entryIndex, entry) {
        var response = "" +  json['description'] + '</br>';
        if (json['media_url'] != undefined) {
          var img = "<img src =\"" + json['media_url'] + "\" />";
          response += img
        }
        $("#image").html(response)
        $("#json_response").html(JSON.stringify(json,null, 4));
      },
      error:function(){
        alert("Error");
      },
    });
  }
});

</pre>
</div></td>
<td valign="top">
RESPONSE:
<div id="spinner"></div>
<pre><code id="json_response"></code></pre></td>
</tr>
</table>
<script>
$(document).ready(function(){
        var opts = {
  		lines: 13, // The number of lines to draw
  		length:10, // The length of each line
  		width: 5, // The line thickness
  		radius: 10, // The radius of the inner circle
  		corners: 1, // Corner roundness (0..1)
  		rotate: 0, // The rotation offset
  		direction: 1, // 1: clockwise, -1: counterclockwise
  		color: '#000', // #rgb or #rrggbb or array of colors
  		speed: 1, // Rounds per second
  		trail: 60, // Afterglow percentage
  		shadow: false, // Whether to render a shadow
  		hwaccel: false, // Whether to use hardware acceleration
  		className: 'spinner', // The CSS class to assign to the spinner
  		zIndex: 2e9, // The z-index (defaults to 2000000000)
  		top: 5, // Top position relative to parent in px
  		left:5  // Left position relative to parent in px
		};
	var target = document.getElementById('spinner');
	var spinner = new Spinner(opts);
	//var spinner = new Spinner(opts).spin(target);

	var map = L.map('map').setView([60.20, 24.93125813367534], 11);
        L.tileLayer('http://{s}.tile.cloudmade.com/31d379fb8a444330931fb9f0baa6411f/998/256/{z}/{x}/{y}.png', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
                maxZoom: 18 }).addTo(map);

        if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(centerMap,error);
        }

        function centerMap(position){
                map.setView([position.coords.latitude, position.coords.longitude], 15);
        }

        function error(msg){
        }

        //TODO: red icon for open requests
        var RedIcon = L.Icon.Default.extend({
                options: {
                        iconUrl: 'icons/marker-icon-red.png'
                }
        });
        var redIcon = new RedIcon();
  	SyntaxHighlighter.all();
        var base_url = 'https://asiointi.hel.fi/palautews/rest/v1/';
	var d = moment().subtract('days', 7).format();
	getReports(base_url + 'requests.json?extensions=true&start_date=' + d);
	
	window.getReports=getReports;
 	var group = L.layerGroup();	
	function getReports(url) {
		spinner.spin(target);	
		$("#url").html('<a href=' + url + '>' + url + '</a>');
		$.ajax({
                        url:url,
                        dataType: 'json', // CORS support in API
                        success:function(json){
                                var response = "";
                                $.each(json, function(entryIndex, entry) {
                                        if (entry['lat'] == undefined ||  entry['long'] == undefined) return true;
					response += getRequestHTML(entry);
					var t = "" + entry['service_request_id'];
					var latlng = new L.LatLng(entry['lat'],entry['long']);
                                        var marker = L.marker([entry['lat'],entry['long']]);
                                        marker._serviceId = "" + entry['service_request_id'];;
					if (entry['status'] == "open") marker.setIcon(redIcon);
					marker.bindPopup(t);
                                        group.addLayer(marker);
                                });
				spinner.stop();
				$("#response").html(response);
				$("#json_response").html(JSON.stringify(json,null,2));
                                $('pre code').each(function(i, e) {hljs.highlightBlock(e)});
				group.addTo(map);
                        },
                        error:function(){
                                alert("Error");
                        },
                });
        }
	map.on('popupopen', function(e) {
		spinner.spin(target);
		var id;
		if (e.popup._source._serviceId != undefined) id = e.popup._source._serviceId;
		if (id != undefined){ 
			var latlng = e.popup._source.getLatLng();
			var url = base_url + 'requests/' + id + '.json?extensions=true';
                	$("#url").html('<a href=' + url + '>' + url + '</a>');
			$("#request_url").val(url);
			$.ajax({
                        	url:url,
                        	dataType: 'json', // CORS support
                        	success:function(json){
					$.each(json, function(entryIndex, entry) {
                                		response = getRequestHTML(entry);
						$("#response").html(response)
                        		});
					spinner.stop();
					$("#json_response").html(JSON.stringify(json,null, 4));
					$('pre code').each(function(i, e) {hljs.highlightBlock(e)});
				},
                        	error:function(){
                                	alert("Error");
                        	},
                	});

		}
	});
	
	map.on('click', function(e) {
		url_query = base_url + "requests.json?radius=500&lat=" + e.latlng.lat + "&long=" +  e.latlng.lng + "&extensions=true";
		getReports(url_query);
		$("#url").html('<a href=' + url_query + '>' + url_query + '</a>');
		$("#request_url").val(url_query);
		group.clearLayers();
		var circle = new L.circle(e.latlng, 500);
		group.addLayer(circle);
		/*
		$.getJSON( url_query, function( data ) { 
			var items = [];
			response = "";
			$.each(data, function(entryIndex, entry) {
				if (entry['media_url'] != undefined) {
					response += "<img src=\"" + entry['media_url'] + "\"></img>";
				}
				var marker = L.marker([entry['lat'],entry['long']]);
				if (entry['status'] == "open") marker.setIcon(redIcon);
        			marker.bindPopup(entry['service_request_id']);
				group.addLayer(marker);
			});
			group.addTo(map);
			$("#json_response").html(JSON.stringify(data,null,2))
			$("#image").html(response)
		});
		*/
	});

        function fetchReports(){
		group.clearLayers();
                var url = $("#request_url");
                getReports(url.val())
        }

	function getRequestHTML(entry){
		var day = moment(entry['requested_datetime']).format("YYYY-MM-DD HH:mm") ;
		var response = "<strong>" + entry['extended_attributes']['title'] + "</strong>" +  "<p style=\"font-size:12px\">" + entry['status'] + " " + day + "</p>" + entry['description'] + '</br>';
	        if (entry['media_url'] != undefined) {
                	response += "<a href=\"" + entry['media_url'] + "\" target=\"_blank\"><img width=\"400\" src =\"" + entry['media_url'] + "\" /></a></br>";
                }
               	response += "<hr/>";
		return response;
	}

        window.fetchReports=fetchReports;
	window.getRequestHTML=getRequestHTML;

});
</script>
</body>
</html>
